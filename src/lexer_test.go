package main

import (
	"fmt"
	"testing"

	"github.com/stretchr/testify/assert"
)

func testCompleteJSON_p(t *testing.T) {
	streamingJSONCase := map[string]string{
		// `{"a":-`:  `{"a":0}`,
		// `{"a":-1`: `{"a":-1}`,
		// `{"a":-1}`: `{"a":-1}`,
		// `{"a":-1,`: `{"a":-1}`,
		// `[-`: `[0]`,
		// `[-1`: `[-1]`,
		// `[-1,`: `[-1]`,
		// `[-1]`: `[-1]`,
		// `[-1,-`: `[-1,0]`,
		// `[-1,-2`: `[-1,-2]`,
		`[-1,-2,-0.10`: `[-1,-2,-0.10]`,
	}
	for testCase, expect := range streamingJSONCase {
		fmt.Printf("\n\n---------------------------\n")
		fmt.Printf("current test case: `%s`\n", testCase)
		lexer := NewLexer()
		errInAppendString := lexer.AppendString(testCase)
		ret := lexer.CompleteJSON()
		assert.Nil(t, errInAppendString)
		if !assert.Equal(t, expect, ret, "unexpected JSON") {
			break
		}
	}

}
func TestCompleteJSON_base(t *testing.T) {
	streamingJSONCase := map[string]string{
		// test case: basic object properity
		`{`:              `{}`,        // mirror stack: [], should remove from stack: [], should push into mirror stack: [`}`]
		`{}`:             `{}`,        // mirror stack: [], should remove from stack: [], should push into mirror stack: []
		`{"`:             `{"":null}`, // mirror stack: [`}`], should remove from stack: [], should push into mirror stack: [`"`, `:`, `n`, `u`, `l`, `l`]
		`{""`:            `{"":null}`, // mirror stack: [`"`, `:`, `n`, `u`, `l`, `l`,`}`], should remove from stack: [`"`], should push into mirror stack: []
		`{"a`:            `{"a":null}`,
		`{"a"`:           `{"a":null}`,
		`{"a":`:          `{"a":null}`,
		`{"a":n`:         `{"a":null}`,
		`{"a":nu`:        `{"a":null}`,
		`{"a":nul`:       `{"a":null}`,
		`{"a":null`:      `{"a":null}`,
		`{"a":null,`:     `{"a":null}`,
		`{"a":t`:         `{"a":true}`,
		`{"a":tr`:        `{"a":true}`,
		`{"a":tru`:       `{"a":true}`,
		`{"a":true`:      `{"a":true}`,
		`{"a":true,`:     `{"a":true}`,
		`{"a":f`:         `{"a":false}`,
		`{"a":fa`:        `{"a":false}`,
		`{"a":fal`:       `{"a":false}`,
		`{"a":fals`:      `{"a":false}`,
		`{"a":false`:     `{"a":false}`,
		`{"a":false,`:    `{"a":false}`,
		`{"a":-`:         `{"a":0}`,
		`{"a":12`:        `{"a":12}`,
		`{"a":-0`:        `{"a":-0}`, // @TODO: should be 0, not -0
		`{"a":-12`:       `{"a":-12}`,
		`{"a":12,`:       `{"a":12}`,
		`{"a":12.`:       `{"a":12.0}`,
		`{"a":12.15`:     `{"a":12.15}`,
		`{"a":12.15,`:    `{"a":12.15}`,
		`{"a":-12.15,`:   `{"a":-12.15}`,
		`{"a":"`:         `{"a":""}`,
		`{"a":""`:        `{"a":""}`,
		`{"a":"",`:       `{"a":""}`,
		`{"a":"string`:   `{"a":"string"}`,
		`{"a":"string"`:  `{"a":"string"}`,
		`{"a":"string",`: `{"a":"string"}`,

		// test case: escape character
		`{"\`:          `{"":null}`,
		`{"\"`:         `{"\"":null}`,
		`{"\""`:        `{"\"":null}`,
		`{"\"\`:        `{"\"":null}`,
		`{"\"\""`:      `{"\"\"":null}`,
		`{"\"":`:       `{"\"":null}`,
		`{"a":"\"`:     `{"a":"\""}`,
		`{"a":"\""`:    `{"a":"\""}`,
		`{"a":"\"\"`:   `{"a":"\"\""}`,
		`{"a":"\"\""`:  `{"a":"\"\""}`,
		`{"a":"\"\"",`: `{"a":"\"\""}`,
		`{"a":"\"\""}`: `{"a":"\"\""}`,
		`{"\\`:         `{"\\":null}`,
		`{"\/`:         `{"\/":null}`,
		`{"\b`:         `{"\b":null}`,
		`{"\f`:         `{"\f":null}`,
		`{"\n`:         `{"\n":null}`,
		`{"\r`:         `{"\r":null}`,
		`{"\t`:         `{"\t":null}`,
		`{"\u0111`:     `{"\u0111":null}`,

		// test case: token in string
		`{"a":"["`:          `{"a":"["}`,
		`{"a":"[]"`:         `{"a":"[]"}`,
		`{"a":"]"`:          `{"a":"]"}`,
		`{"a":"{"`:          `{"a":"{"}`,
		`{"a":"{}"`:         `{"a":"{}"}`,
		`{"a":"}"`:          `{"a":"}"}`,
		`{"a":","`:          `{"a":","}`,
		`{"a":"."`:          `{"a":"."}`,
		`{"a":"","`:         `{"a":"","":null}`,
		`{"a":"","b`:        `{"a":"","b":null}`,
		`{"a":"","b"`:       `{"a":"","b":null}`,
		`{"a":"","b":`:      `{"a":"","b":null}`,
		`{"a":"","b":"`:     `{"a":"","b":""}`,
		`{"a":"","b":""`:    `{"a":"","b":""}`,
		`{"a":"","b":""}`:   `{"a":"","b":""}`,
		`{"1`:               `{"1":null}`,
		`{"1.`:              `{"1.":null}`,
		`{"1.1`:             `{"1.1":null}`,
		`{"1.10`:            `{"1.10":null}`,
		`{"1"`:              `{"1":null}`,
		`{"1":`:             `{"1":null}`,
		`{"1":"`:            `{"1":""}`,
		`{"1":"1`:           `{"1":"1"}`,
		`{"1":"1.`:          `{"1":"1."}`,
		`{"1":"1.1`:         `{"1":"1.1"}`,
		`{"1":"1.10`:        `{"1":"1.10"}`,
		`{"1":"1"`:          `{"1":"1"}`,
		`{"1":"1"}`:         `{"1":"1"}`,
		`{"-1":"-1"}`:       `{"-1":"-1"}`,
		`{"t`:               `{"t":null}`,
		`{"tr`:              `{"tr":null}`,
		`{"tru`:             `{"tru":null}`,
		`{"true`:            `{"true":null}`,
		`{"true"`:           `{"true":null}`,
		`{"true":`:          `{"true":null}`,
		`{"true":"t`:        `{"true":"t"}`,
		`{"true":"tr`:       `{"true":"tr"}`,
		`{"true":"tru`:      `{"true":"tru"}`,
		`{"true":"true`:     `{"true":"true"}`,
		`{"true":"true"`:    `{"true":"true"}`,
		`{"true":"true"}`:   `{"true":"true"}`,
		`{"f`:               `{"f":null}`,
		`{"fa`:              `{"fa":null}`,
		`{"fal`:             `{"fal":null}`,
		`{"fals`:            `{"fals":null}`,
		`{"false`:           `{"false":null}`,
		`{"false"`:          `{"false":null}`,
		`{"false":`:         `{"false":null}`,
		`{"false":"f`:       `{"false":"f"}`,
		`{"false":"fa`:      `{"false":"fa"}`,
		`{"false":"fal`:     `{"false":"fal"}`,
		`{"false":"fals`:    `{"false":"fals"}`,
		`{"false":"false`:   `{"false":"false"}`,
		`{"false":"false"`:  `{"false":"false"}`,
		`{"false":"false"}`: `{"false":"false"}`,
		`{"n`:               `{"n":null}`,
		`{"nu`:              `{"nu":null}`,
		`{"nul`:             `{"nul":null}`,
		`{"null`:            `{"null":null}`,
		`{"null"`:           `{"null":null}`,
		`{"null":`:          `{"null":null}`,
		`{"null":"n`:        `{"null":"n"}`,
		`{"null":"nu`:       `{"null":"nu"}`,
		`{"null":"nul`:      `{"null":"nul"}`,
		`{"null":"null`:     `{"null":"null"}`,
		`{"null":"null"`:    `{"null":"null"}`,
		`{"null":"null"}`:   `{"null":"null"}`,

		// test case: array as object value
		`{"a":[`:            `{"a":[]}`,
		`{"a":[]`:           `{"a":[]}`,
		`{"a":[1`:           `{"a":[1]}`,
		`{"a":[1,`:          `{"a":[1]}`,
		`{"a":[-0,`:         `{"a":[-0]}`, // @TODO: should be 0, not -0
		`{"a":[-1,`:         `{"a":[-1]}`,
		`{"a":[1,0`:         `{"a":[1,0]}`,
		`{"a":[1,0.0`:       `{"a":[1,0.0]}`,
		`{"a":[1,0.01`:      `{"a":[1,0.01]}`,
		`{"a":[1,0.01]`:     `{"a":[1,0.01]}`,
		`{"a":[1,0.01]}`:    `{"a":[1,0.01]}`,
		`{"a":[-1,0.01]}`:   `{"a":[-1,0.01]}`,
		`{"a":[-1,-`:        `{"a":[-1,0]}`,
		`{"a":[-1,-0`:       `{"a":[-1,-0]}`, // @TODO: should be 0, not -0
		`{"a":[1,-0.01]}`:   `{"a":[1,-0.01]}`,
		`{"a":[-1,-0.01]}`:  `{"a":[-1,-0.01]}`,
		`{"a":[n`:           `{"a":[null]}`,
		`{"a":[nu`:          `{"a":[null]}`,
		`{"a":[nul`:         `{"a":[null]}`,
		`{"a":[null`:        `{"a":[null]}`,
		`{"a":[null,`:       `{"a":[null]}`,
		`{"a":[null]`:       `{"a":[null]}`,
		`{"a":[null]}`:      `{"a":[null]}`,
		`{"a":[t`:           `{"a":[true]}`,
		`{"a":[tr`:          `{"a":[true]}`,
		`{"a":[tru`:         `{"a":[true]}`,
		`{"a":[true`:        `{"a":[true]}`,
		`{"a":[true,`:       `{"a":[true]}`,
		`{"a":[true]`:       `{"a":[true]}`,
		`{"a":[true]}`:      `{"a":[true]}`,
		`{"a":[f`:           `{"a":[false]}`,
		`{"a":[fa`:          `{"a":[false]}`,
		`{"a":[fal`:         `{"a":[false]}`,
		`{"a":[fals`:        `{"a":[false]}`,
		`{"a":[false`:       `{"a":[false]}`,
		`{"a":[false,`:      `{"a":[false]}`,
		`{"a":[false]`:      `{"a":[false]}`,
		`{"a":[false]}`:     `{"a":[false]}`,
		`{"a":["`:           `{"a":[""]}`,
		`{"a":["b`:          `{"a":["b"]}`,
		`{"a":["b"`:         `{"a":["b"]}`,
		`{"a":["b",`:        `{"a":["b"]}`,
		`{"a":["b"]`:        `{"a":["b"]}`,
		`{"a":["b"]}`:       `{"a":["b"]}`,
		`{"a":[{`:           `{"a":[{}]}`,
		`{"a":[{"`:          `{"a":[{"":null}]}`,
		`{"a":[{"b`:         `{"a":[{"b":null}]}`,
		`{"a":[{"b"`:        `{"a":[{"b":null}]}`,
		`{"a":[{"b":`:       `{"a":[{"b":null}]}`,
		`{"a":[{"b":"`:      `{"a":[{"b":""}]}`,
		`{"a":[{"b":"c`:     `{"a":[{"b":"c"}]}`,
		`{"a":[{"b":"c"`:    `{"a":[{"b":"c"}]}`,
		`{"a":[{"b":"c",`:   `{"a":[{"b":"c"}]}`,
		`{"a":[{"b":"c"}`:   `{"a":[{"b":"c"}]}`,
		`{"a":[{"b":"c"}]`:  `{"a":[{"b":"c"}]}`,
		`{"a":[{"b":"c"}]}`: `{"a":[{"b":"c"}]}`,

		// test case: object as object value
		`{"a":{`:          `{"a":{}}`,
		`{"a":{"`:         `{"a":{"":null}}`,
		`{"a":{"b`:        `{"a":{"b":null}}`,
		`{"a":{"b"`:       `{"a":{"b":null}}`,
		`{"a":{"b":`:      `{"a":{"b":null}}`,
		`{"a":{"b":"`:     `{"a":{"b":""}}`,
		`{"a":{"b":"c`:    `{"a":{"b":"c"}}`,
		`{"a":{"b":"c"`:   `{"a":{"b":"c"}}`,
		`{"a":{"b":"c",`:  `{"a":{"b":"c"}}`,
		`{"a":{"b":"c"}`:  `{"a":{"b":"c"}}`,
		`{"a":{"b":"c"}}`: `{"a":{"b":"c"}}`,

		// test case: multiple object properity
		`{"a":1,"b":1.20,"c":0.03,"d":-1,"e":-1.20,"f":-0.03,"g":"a","h":null,"i":true,"j":false,"k":{},"l":[]]}`: `{"a":1,"b":1.20,"c":0.03,"d":-1,"e":-1.20,"f":-0.03,"g":"a","h":null,"i":true,"j":false,"k":{},"l":[]]}`,

		// test case: basic array element
		`[`:            `[]`,
		`[]`:           `[]`,
		`[n`:           `[null]`,
		`[nu`:          `[null]`,
		`[nul`:         `[null]`,
		`[null`:        `[null]`,
		`[null,`:       `[null]`,
		`[null,null`:   `[null,null]`,
		`[t`:           `[true]`,
		`[tr`:          `[true]`,
		`[tru`:         `[true]`,
		`[true`:        `[true]`,
		`[true,`:       `[true]`,
		`[true,true`:   `[true,true]`,
		`[f`:           `[false]`,
		`[fa`:          `[false]`,
		`[fal`:         `[false]`,
		`[fals`:        `[false]`,
		`[false`:       `[false]`,
		`[false,`:      `[false]`,
		`[false,false`: `[false,false]`,
		`[0`:           `[0]`,
		`[-`:           `[0]`,
		`[-1`:          `[-1]`,
		`[0,`:          `[0]`,
		`[-1,`:         `[-1]`,
		`[-1,-`:        `[-1,0]`,
		`[0.`:          `[0.0]`,
		`[-0.`:         `[-0.0]`,
		`[0.1`:         `[0.1]`,
		`[0.12,`:       `[0.12]`,
		`[-0.12,`:      `[-0.12]`,
		`[1,2,`:        `[1,2]`,
		`[1,2,0`:       `[1,2,0]`,
		`[1,2,0.`:      `[1,2,0.0]`,
		`[1,2,0.1`:     `[1,2,0.1]`,
		`[1,2,0.10`:    `[1,2,0.10]`,
		`[-1,2,0.10`:   `[-1,2,0.10]`,
		`[-1,-2,0.10`:  `[-1,-2,0.10]`,
		`[-1,-2,-0.10`: `[-1,-2,-0.10]`,
		`[1,-2,-0.10`:  `[1,-2,-0.10]`,
		`[1,2,-0.10`:   `[1,2,-0.10]`,
		`[1,-2,0.10`:   `[1,-2,0.10]`,
		`["`:           `[""]`,
		`[""`:          `[""]`,
		`["",`:         `[""]`,
		`["a`:          `["a"]`,
		`["a"`:         `["a"]`,
		`["a",`:        `["a"]`,
		`["a","`:       `["a",""]`,
		`["a","b`:      `["a","b"]`,
		`["a","b"`:     `["a","b"]`,
		`["a","b",`:    `["a","b"]`,
		`["a","b"]`:    `["a","b"]`,

		// test case: object as array element
		`[{`:                        `[{}]`,
		`[{"`:                       `[{"":null}]`,
		`[{""`:                      `[{"":null}]`,
		`[{"":`:                     `[{"":null}]`,
		`[{"":"`:                    `[{"":""}]`,
		`[{"":""`:                   `[{"":""}]`,
		`[{"":""}`:                  `[{"":""}]`,
		`[{"":""}]`:                 `[{"":""}]`,
		`[{"a`:                      `[{"a":null}]`,
		`[{"a"`:                     `[{"a":null}]`,
		`[{"a":`:                    `[{"a":null}]`,
		`[{"a":"`:                   `[{"a":""}]`,
		`[{"a":"b`:                  `[{"a":"b"}]`,
		`[{"a":"b"`:                 `[{"a":"b"}]`,
		`[{"a":"b"}`:                `[{"a":"b"}]`,
		`[{"a":"b"}]`:               `[{"a":"b"}]`,
		`[{"a":n`:                   `[{"a":null}]`,
		`[{"a":nu`:                  `[{"a":null}]`,
		`[{"a":nul`:                 `[{"a":null}]`,
		`[{"a":null`:                `[{"a":null}]`,
		`[{"a":null,`:               `[{"a":null}]`,
		`[{"a":null}`:               `[{"a":null}]`,
		`[{"a":null}]`:              `[{"a":null}]`,
		`[{"a":t`:                   `[{"a":true}]`,
		`[{"a":tr`:                  `[{"a":true}]`,
		`[{"a":tru`:                 `[{"a":true}]`,
		`[{"a":true`:                `[{"a":true}]`,
		`[{"a":true,`:               `[{"a":true}]`,
		`[{"a":true}`:               `[{"a":true}]`,
		`[{"a":true}]`:              `[{"a":true}]`,
		`[{"a":f`:                   `[{"a":false}]`,
		`[{"a":fa`:                  `[{"a":false}]`,
		`[{"a":fal`:                 `[{"a":false}]`,
		`[{"a":fals`:                `[{"a":false}]`,
		`[{"a":false`:               `[{"a":false}]`,
		`[{"a":false,`:              `[{"a":false}]`,
		`[{"a":false}`:              `[{"a":false}]`,
		`[{"a":false}]`:             `[{"a":false}]`,
		`[{"a":0`:                   `[{"a":0}]`,
		`[{"a":0.`:                  `[{"a":0.0}]`,
		`[{"a":0.1`:                 `[{"a":0.1}]`,
		`[{"a":0.10`:                `[{"a":0.10}]`,
		`[{"a":0.10,`:               `[{"a":0.10}]`,
		`[{"a":0.10}`:               `[{"a":0.10}]`,
		`[{"a":0.10}]`:              `[{"a":0.10}]`,
		`[{"a":-0.10}]`:             `[{"a":-0.10}]`,
		`[{"a":[`:                   `[{"a":[]}]`,
		`[{"a":[1`:                  `[{"a":[1]}]`,
		`[{"a":[t`:                  `[{"a":[true]}]`,
		`[{"a":[f`:                  `[{"a":[false]}]`,
		`[{"a":[n`:                  `[{"a":[null]}]`,
		`[{"a":["`:                  `[{"a":[""]}]`,
		`[{"a":[{`:                  `[{"a":[{}]}]`,
		`[{"a":[{"b":"c"},{`:        `[{"a":[{"b":"c"},{}]}]`,
		`[{"a":[{"b":"c"},{"`:       `[{"a":[{"b":"c"},{"":null}]}]`,
		`[{"a":[{"b":"c"},{"d"`:     `[{"a":[{"b":"c"},{"d":null}]}]`,
		`[{"a":[{"b":"c"},{"d":1.`:  `[{"a":[{"b":"c"},{"d":1.0}]}]`,
		`[{"a":[{"b":"c"},{"d":1.1`: `[{"a":[{"b":"c"},{"d":1.1}]}]`,
		`[{"a":[{"b":"c"},{"d":[`:   `[{"a":[{"b":"c"},{"d":[]}]}]`,
		`[{"a":[{"b":"c"},{"d":[{`:  `[{"a":[{"b":"c"},{"d":[{}]}]}]`,

		// test case: multiple array element
		`[1,1.20,0.03,-1,-1.20,-0.03,"a",null,true,false,{},[]]`: `[1,1.20,0.03,-1,-1.20,-0.03,"a",null,true,false,{},[]]`,

		// test case: array as array element
		`[[`:                `[[]]`,
		`[[]`:               `[[]]`,
		`[[]]`:              `[[]]`,
		`[[{`:               `[[{}]]`,
		`[["`:               `[[""]]`,
		`[[""`:              `[[""]]`,
		`[["a`:              `[["a"]]`,
		`[["a"`:             `[["a"]]`,
		`[["a"]`:            `[["a"]]`,
		`[["a"],`:           `[["a"]]`,
		`[["a"],[`:          `[["a"],[]]`,
		`[["a"],[]`:         `[["a"],[]]`,
		`[["a"],[]]`:        `[["a"],[]]`,
		`[["a"],{`:          `[["a"],{}]`,
		`[["a"],{}`:         `[["a"],{}]`,
		`[["a"],{}]`:        `[["a"],{}]`,
		`[["a"],{"`:         `[["a"],{"":null}]`,
		`[["a"],{"b`:        `[["a"],{"b":null}]`,
		`[["a"],{"b"`:       `[["a"],{"b":null}]`,
		`[["a"],{"b":`:      `[["a"],{"b":null}]`,
		`[["a"],{"b":"`:     `[["a"],{"b":""}]`,
		`[["a"],{"b":"c`:    `[["a"],{"b":"c"}]`,
		`[["a"],{"b":"c"`:   `[["a"],{"b":"c"}]`,
		`[["a"],{"b":"c"}`:  `[["a"],{"b":"c"}]`,
		`[["a"],{"b":"c"}]`: `[["a"],{"b":"c"}]`,
	}
	for testCase, expect := range streamingJSONCase {
		fmt.Printf("\n\n---------------------------\n")
		fmt.Printf("current test case: `%s`\n", testCase)
		lexer := NewLexer()
		errInAppendString := lexer.AppendString(testCase)
		ret := lexer.CompleteJSON()
		assert.Nil(t, errInAppendString)
		if !assert.Equal(t, expect, ret, "unexpected JSON") {
			break
		}
	}
}
